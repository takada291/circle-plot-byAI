<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>林業プロット測定儀</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        /* カメラ映像 */
        video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        
        /* UIレイヤー */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* 十字線（レチクル） */
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: red;
            transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* 判定結果表示 */
        #judgement {
            position: absolute; top: 35%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            display: none;
        }
        .status-in { color: #00ff00; }
        .status-out { color: #ff0000; }

        /* コントロールパネル（下部） */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8); padding: 15px;
            pointer-events: auto;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        input[type="number"] { width: 60px; padding: 5px; font-size: 16px; border-radius: 4px; border: none; }
        button { padding: 10px 20px; font-size: 14px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-set { background: #ffa500; color: black; font-weight: bold; }
        
        /* カウンター */
        #counter-box {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px;
            text-align: center; pointer-events: auto;
        }
        #count-val { font-size: 24px; font-weight: bold; color: yellow; }
        #btn-count { background: #28a745; color: white; width: 100%; margin-top: 5px; padding: 8px; font-weight: bold;}
        
        /* 情報表示 */
        #info-box {
            position: absolute; top: 10px; left: 10px;
            font-size: 12px; line-height: 1.4; opacity: 0.8;
        }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>

    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="judgement">STANDBY</div>
    </div>

    <div id="info-box">
        俯角: <span id="debug-pitch">0</span>°<br>
        方位: <span id="debug-heading">0</span>°<br>
        補正後半径: <span id="debug-radius">--</span>m
    </div>

    <div id="counter-box">
        <div>本数</div>
        <div id="count-val">0</div>
        <button id="btn-count" onclick="incrementCount()">＋</button>
        <button onclick="resetCount()" style="font-size:10px; background:#666; color:white; margin-top:5px; width:100%;">クリア</button>
    </div>

    <div id="controls">
        <div class="row">
            <label>1. 目の高さ(cm)</label>
            <input type="number" id="eyeHeight" value="160">
        </div>
        <div class="row">
            <label>2. 山の傾斜(度)</label>
            <input type="number" id="slopeAngle" value="0">
        </div>
        <div class="row">
            <label>3. 山の方向セット</label>
            <button class="btn-set" id="btn-set-slope" onclick="setSlopeDirection()">現在の方位を山側にする</button>
        </div>
        <div style="font-size: 10px; color: #ccc; text-align: center; margin-top: 5px;">
            ※半径は5.6m固定設定
        </div>
        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="requestPermissions()">センサー開始 (iOS必須)</button>
    </div>

<script>
    // 設定値
    const PLOT_RADIUS = 5.6; // 半径 (m)
    
    // 変数
    let eyeHeight = 1.6; // m
    let slopeAngleDeg = 0; // 度
    let slopeAzimuth = null; // 山側の方位（0-360）
    let currentAlpha = 0; // 現在の方位
    let currentBeta = 90; // 現在のピッチ（90が直立）
    let count = 0;

    // カメラ起動
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        } catch (err) {
            alert("カメラの起動に失敗しました: " + err);
        }
    }

    // センサー許可リクエスト (iOS 13+対応)
    function requestPermissions() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        document.getElementById('controls').style.display = 'none'; // 設定後は隠す（任意）
                    } else {
                        alert("センサー権限が必要です");
                    }
                })
                .catch(console.error);
        } else {
            // Android他
            window.addEventListener('deviceorientation', handleOrientation);
        }
        startCamera();
        updateSettings();
    }

    // 設定更新
    function updateSettings() {
        eyeHeight = parseFloat(document.getElementById('eyeHeight').value) / 100; // cm -> m
        slopeAngleDeg = parseFloat(document.getElementById('slopeAngle').value);
    }

    // 山側の方位をセット
    function setSlopeDirection() {
        if(currentAlpha !== null) {
            slopeAzimuth = currentAlpha;
            alert(`山側の方位を ${Math.round(slopeAzimuth)}° に設定しました。\n以後、この方向を「上り」、反対を「下り」として補正します。`);
            updateSettings();
        }
    }

    // センサー処理ループ
    function handleOrientation(event) {
        // iOSとAndroidでalphaの扱いが違うが、今回は「セットした瞬間からの相対差」を使うため
        // 絶対方位（北）が合っているかは無視できるロジックにする
        
        // iOS Webkit対応 (webkitCompassHeadingがある場合はそちらを優先)
        if (event.webkitCompassHeading) {
            currentAlpha = event.webkitCompassHeading;
        } else {
            currentAlpha = event.alpha;
        }
        
        currentBeta = event.beta; // スマホの縦の傾き

        // 90度（直立）～0度（水平）～マイナス（上向き）への変換
        // 一般的に beta=90 が直立。ターゲットを見る時は beta < 90 になるはず
        let lookDownAngle = 90 - currentBeta; // 水平から下に何度向いているか

        calculate(lookDownAngle, currentAlpha);
    }

    // 計算ロジック
    function calculate(lookDownAngleDeg, currentAzimuth) {
        const h = eyeHeight;
        const R = PLOT_RADIUS;
        
        // 1. 斜面補正係数の計算
        let effectiveSlopeDeg = 0;
        
        if (slopeAzimuth !== null) {
            // 山側方位との差分 (-180 ～ 180度)
            let diff = currentAzimuth - slopeAzimuth;
            // 角度をラジアンに
            let diffRad = diff * (Math.PI / 180);
            // 現在向いている方向の勾配 = 最大勾配 * cos(方位差)
            // 例: 山側(0度差)なら cos(0)=1 (最大勾配), 横(90度差)なら cos(90)=0 (平坦)
            effectiveSlopeDeg = slopeAngleDeg * Math.cos(diffRad);
        }

        // 2. 判定基準となる「境界線の俯角」を計算
        // 公式: tan(θ_limit) = h/R - tan(α_slope)
        // ※ θ_limit: 境界となる視線角度（水平＝0、下＝正）
        // ※ α_slope: 地面の勾配（上り＝正、下り＝負）
        
        const slopeRad = effectiveSlopeDeg * (Math.PI / 180);
        const term = (h / R) - Math.tan(slopeRad);
        const limitRad = Math.atan(term);
        const limitDeg = limitRad * (180 / Math.PI); // これより下ならIN

        // デバッグ表示
        document.getElementById('debug-pitch').innerText = lookDownAngleDeg.toFixed(1);
        document.getElementById('debug-heading').innerText = Math.round(currentAzimuth);
        
        // 3. 判定
        const judgeElem = document.getElementById('judgement');
        
        // 視線角度が、境界角度より「下（大きい）」ならIN（近い）
        // 視線角度が、境界角度より「上（小さい）」ならOUT（遠い）
        
        if (lookDownAngleDeg > limitDeg) {
            judgeElem.style.display = 'block';
            judgeElem.innerText = 'IN';
            judgeElem.className = 'status-in';
            // 十字線の色も変える
            document.getElementById('crosshair').style.borderColor = '#00ff00';
        } else {
            judgeElem.style.display = 'block';
            judgeElem.innerText = 'OUT';
            judgeElem.className = 'status-out';
             document.getElementById('crosshair').style.borderColor = '#ff0000';
        }
    }

    // カウンター処理
    function incrementCount() {
        count++;
        document.getElementById('count-val').innerText = count;
    }
    function resetCount() {
        if(confirm("カウントを0に戻しますか？")) {
            count = 0;
            document.getElementById('count-val').innerText = count;
        }
    }
</script>
</body>
</html>